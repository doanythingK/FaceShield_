name: Build macOS App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore packages
      run: dotnet restore FaceShield.sln

    - name: Publish macOS app (self-contained)
      run: dotnet publish FaceShield.csproj -c Release -r osx-arm64 --self-contained true -p:PublishSingleFile=true -p:PublishTrimmed=false

    - name: Debug publish output
      run: |
        echo "=== Current directory ==="
        pwd
        echo "=== List everything recursively ==="
        ls -R .
        
    - name: Prepare .app bundle
      run: |
        APP_NAME="FaceShield"
        PUBLISH_DIR="bin/Release/net8.0/osx-arm64/publish"

        mkdir -p "$APP_NAME.app/Contents/MacOS"
        mkdir -p "$APP_NAME.app/Contents/Resources"

        # 실행 가능한 macOS 바이너리 복사
        cp "$PUBLISH_DIR/$APP_NAME" "$APP_NAME.app/Contents/MacOS/$APP_NAME"

        # Info.plist 생성
        cat > "$APP_NAME.app/Contents/Info.plist" <<EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" 
         "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>CFBundleName</key>
          <string>FaceShield</string>
          <key>CFBundleIdentifier</key>
          <string>com.faceshield.app</string>
          <key>CFBundleExecutable</key>
          <string>FaceShield</string>
          <key>CFBundleVersion</key>
          <string>1.0.0</string>
          <key>CFBundlePackageType</key>
          <string>APPL</string>
        </dict>
        </plist>
        EOF

    - name: Zip app for release
      run: zip -r FaceShield-macOS.zip FaceShield.app

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: FaceShield-macOS
        path: FaceShield-macOS.zip
